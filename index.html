<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Project Baguette – Menu Prototype</title>

  <!-- Tailwind CDN (fast prototype) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- p5.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.2/p5.min.js"></script>

  <style>
    /* Keep p5 canvas behind UI */
    #bg-canvas-holder canvas {
      position: absolute !important;
      inset: 0 !important;
      width: 100% !important;
      height: 100% !important;
      z-index: 0 !important;
    }
  </style>
</head>

<body class="bg-slate-950 text-white overflow-hidden">
  <!-- Background layer (p5) -->
  <div id="bg-canvas-holder" class="fixed inset-0"></div>

  <!-- Dark overlay for readability -->
  <div class="fixed inset-0 bg-slate-950/60 z-10"></div>

  <!-- UI layer -->
  <div class="relative z-20 min-h-screen flex">
    <!-- LEFT: Song list panel -->
    <aside class="w-[360px] max-w-[90vw] border-r border-white/10 bg-slate-900/50 backdrop-blur-xl">
      <div class="p-4 border-b border-white/10">
        <div class="text-2xl font-extrabold tracking-tight">Project Baguette</div>
        <div class="text-xs text-white/60 mt-1">WASD • Enter to start • Esc to back</div>
      </div>

      <!-- Search -->
      <div class="p-3">
        <input id="search"
          class="w-full px-3 py-2 rounded-xl bg-white/5 border border-white/10 outline-none
                 focus:border-white/30 focus:bg-white/10 text-sm"
          placeholder="Search songs..."
          autocomplete="off"
        />
      </div>

      <!-- Song list -->
      <div id="songList" class="px-2 pb-3 overflow-auto h-[calc(100vh-148px)]"></div>
    </aside>

    <!-- RIGHT: Details + Actions -->
    <main class="flex-1 flex flex-col">
      <!-- Top bar -->
      <header class="p-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-2 h-2 rounded-full bg-emerald-400"></div>
          <div class="text-sm text-white/70">Main Menu</div>
        </div>

        <div class="flex gap-2">
          <button id="btnSettings"
            class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 text-sm">
            Settings
          </button>
          <button id="btnQuit"
            class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 text-sm">
            Quit
          </button>
        </div>
      </header>

      <!-- Content -->
      <section class="flex-1 grid grid-cols-12 gap-4 px-4 pb-4">
        <!-- Song details card -->
        <div class="col-span-12 xl:col-span-7 rounded-2xl border border-white/10 bg-slate-900/40 backdrop-blur-xl p-5">
          <div class="flex items-start justify-between gap-4">
            <div>
              <div id="songTitle" class="text-3xl font-extrabold tracking-tight">—</div>
              <div id="songArtist" class="text-sm text-white/70 mt-1">—</div>
            </div>

            <div class="text-right">
              <div class="text-xs text-white/50">BPM</div>
              <div id="songBpm" class="text-lg font-semibold">—</div>
            </div>
          </div>

          <div class="mt-5 grid grid-cols-2 md:grid-cols-4 gap-3">
            <div class="rounded-xl bg-white/5 border border-white/10 p-3">
              <div class="text-xs text-white/50">Difficulty</div>
              <div id="songDiff" class="text-base font-semibold">—</div>
            </div>
            <div class="rounded-xl bg-white/5 border border-white/10 p-3">
              <div class="text-xs text-white/50">Length</div>
              <div id="songLen" class="text-base font-semibold">—</div>
            </div>
            <div class="rounded-xl bg-white/5 border border-white/10 p-3">
              <div class="text-xs text-white/50">Charts</div>
              <div id="songCharts" class="text-base font-semibold">—</div>
            </div>
            <div class="rounded-xl bg-white/5 border border-white/10 p-3">
              <div class="text-xs text-white/50">Source</div>
              <div id="songSource" class="text-base font-semibold">—</div>
            </div>
          </div>

          <div class="mt-5 text-sm text-white/70 leading-relaxed">
            <div class="text-xs text-white/50 mb-1">Notes</div>
            <div id="songNotes">Select a song on the left.</div>
          </div>
        </div>

        <!-- Actions card -->
        <div class="col-span-12 xl:col-span-5 rounded-2xl border border-white/10 bg-slate-900/40 backdrop-blur-xl p-5">
          <div class="text-xl font-bold">Play</div>
          <div class="text-sm text-white/70 mt-1">
            This menu is UI-only. Your engine should be called via a single command like <span class="font-mono text-white/90">engine.start(songId, diff)</span>.
          </div>

          <div class="mt-4 flex flex-col gap-3">
            <button id="btnStart"
              class="px-4 py-3 rounded-2xl bg-emerald-500/90 hover:bg-emerald-400 text-slate-950 font-bold">
              Start (Enter)
            </button>

            <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
              <div class="text-sm font-semibold">Difficulty Select</div>
              <div class="mt-3 flex flex-wrap gap-2" id="diffButtons"></div>
            </div>

            <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
              <div class="text-sm font-semibold">Import / Autogen</div>
              <div class="mt-2 text-sm text-white/70">
                Later: “Import R+ Chart” + “Autogenerate Chart” buttons. Keep these as dumb commands into your core.
              </div>
              <div class="mt-3 flex gap-2">
                <button id="btnImport"
                  class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 text-sm">
                  Import R+ (stub)
                </button>
                <button id="btnAutogen"
                  class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 text-sm">
                  Autogen (stub)
                </button>
              </div>
            </div>

            <div class="text-xs text-white/50 mt-1">
              Keyboard: ↑/↓ choose song • ←/→ difficulty • Enter start • Esc back
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // -------------------------
    // STATE (UI should not own engine truth — just selection)
    // -------------------------
    const songs = [
      {
        id: "demo-1",
        title: "Demo Song",
        artist: "Project Baguette",
        bpm: 128,
        length: "2:12",
        source: "Local",
        notes: "Starter song for testing UI and flow.",
        charts: {
          Easy: 2,
          Normal: 5,
          Hard: 8,
          Extreme: 10
        }
      },
      {
        id: "demo-2",
        title: "Overclocked – DryftIN",
        artist: "Placeholder Artist",
        bpm: 174,
        length: "1:58",
        source: "Local",
        notes: "Example entry. Replace with your real library list.",
        charts: {
          Easy: 3,
          Normal: 6,
          Hard: 9
        }
      },
      {
        id: "import-slot",
        title: "Import Slot",
        artist: "R+ Chart",
        bpm: 0,
        length: "—",
        source: "User",
        notes: "Reserved slot for imported charts.",
        charts: {
          Normal: 0
        }
      }
    ];

    let filtered = [...songs];
    let selectedSongIndex = 0;
    let selectedDiffIndex = 0;
    let diffsForSelected = [];

    const elSongList = document.getElementById("songList");
    const elSearch = document.getElementById("search");

    const elTitle = document.getElementById("songTitle");
    const elArtist = document.getElementById("songArtist");
    const elBpm = document.getElementById("songBpm");
    const elDiff = document.getElementById("songDiff");
    const elLen = document.getElementById("songLen");
    const elCharts = document.getElementById("songCharts");
    const elSource = document.getElementById("songSource");
    const elNotes = document.getElementById("songNotes");
    const elDiffButtons = document.getElementById("diffButtons");

    const btnStart = document.getElementById("btnStart");
    const btnImport = document.getElementById("btnImport");
    const btnAutogen = document.getElementById("btnAutogen");

    // -------------------------
    // RENDER HELPERS
    // -------------------------
    function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

    function getSelectedSong() {
      return filtered[clamp(selectedSongIndex, 0, Math.max(0, filtered.length - 1))] || null;
    }

    function buildDiffs(song) {
      if (!song) return [];
      return Object.keys(song.charts || {});
    }

    function renderSongList() {
      elSongList.innerHTML = "";

      if (filtered.length === 0) {
        elSongList.innerHTML = `
          <div class="p-4 text-sm text-white/60">
            No matches.
          </div>`;
        return;
      }

      filtered.forEach((s, idx) => {
        const isSel = idx === selectedSongIndex;
        const div = document.createElement("button");
        div.className =
          "w-full text-left rounded-xl px-3 py-3 mb-2 border transition " +
          (isSel
            ? "bg-white/10 border-white/30"
            : "bg-white/0 border-white/10 hover:bg-white/5 hover:border-white/20");

        div.innerHTML = `
          <div class="flex items-center justify-between gap-2">
            <div class="min-w-0">
              <div class="font-semibold truncate">${escapeHtml(s.title)}</div>
              <div class="text-xs text-white/60 truncate">${escapeHtml(s.artist)}</div>
            </div>
            <div class="text-xs text-white/50 shrink-0">${s.bpm ? s.bpm + " BPM" : ""}</div>
          </div>
        `;

        div.addEventListener("click", () => {
          selectedSongIndex = idx;
          selectedDiffIndex = 0;
          syncDetails();
        });

        elSongList.appendChild(div);
      });

      // Keep selected in view
      const selEl = elSongList.children[selectedSongIndex];
      if (selEl && selEl.scrollIntoView) {
        selEl.scrollIntoView({ block: "nearest" });
      }
    }

    function renderDiffButtons(song) {
      elDiffButtons.innerHTML = "";
      diffsForSelected = buildDiffs(song);
      selectedDiffIndex = clamp(selectedDiffIndex, 0, Math.max(0, diffsForSelected.length - 1));

      diffsForSelected.forEach((d, idx) => {
        const isSel = idx === selectedDiffIndex;
        const btn = document.createElement("button");
        btn.className =
          "px-3 py-2 rounded-xl border text-sm transition " +
          (isSel
            ? "bg-emerald-500/90 border-emerald-300 text-slate-950 font-bold"
            : "bg-white/5 border-white/10 hover:bg-white/10 hover:border-white/20 text-white");

        const level = (song.charts && song.charts[d] != null) ? song.charts[d] : "—";
        btn.textContent = `${d} ${level ? "• " + level : ""}`;

        btn.addEventListener("click", () => {
          selectedDiffIndex = idx;
          syncDetails(false);
        });

        elDiffButtons.appendChild(btn);
      });
    }

    function syncDetails(rerenderList = true) {
      const song = getSelectedSong();

      if (!song) {
        elTitle.textContent = "—";
        elArtist.textContent = "—";
        elBpm.textContent = "—";
        elDiff.textContent = "—";
        elLen.textContent = "—";
        elCharts.textContent = "—";
        elSource.textContent = "—";
        elNotes.textContent = "Select a song on the left.";
        elDiffButtons.innerHTML = "";
        return;
      }

      // Update diffs first so selectedDiffIndex is valid
      const diffs = buildDiffs(song);
      diffsForSelected = diffs;
      selectedDiffIndex = clamp(selectedDiffIndex, 0, Math.max(0, diffs.length - 1));
      const chosenDiff = diffs[selectedDiffIndex] || "—";

      elTitle.textContent = song.title;
      elArtist.textContent = song.artist;
      elBpm.textContent = song.bpm ? String(song.bpm) : "—";
      elDiff.textContent = chosenDiff;
      elLen.textContent = song.length || "—";
      elSource.textContent = song.source || "—";
      elNotes.textContent = song.notes || "—";

      const chartCount = diffs.length;
      elCharts.textContent = chartCount ? `${chartCount}` : "0";

      renderDiffButtons(song);

      if (rerenderList) renderSongList();

      // Let p5 know selection changed (for reactive background)
      window.__PB_MENU_STATE__ = {
        songId: song.id,
        bpm: song.bpm || 120,
        diff: chosenDiff,
        diffIndex: selectedDiffIndex
      };
    }

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, (c) => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
      }[c]));
    }

    // -------------------------
    // SEARCH
    // -------------------------
    elSearch.addEventListener("input", () => {
      const q = elSearch.value.trim().toLowerCase();
      filtered = songs.filter(s =>
        s.title.toLowerCase().includes(q) || s.artist.toLowerCase().includes(q)
      );
      selectedSongIndex = clamp(selectedSongIndex, 0, Math.max(0, filtered.length - 1));
      selectedDiffIndex = 0;
      syncDetails(true);
    });

    // -------------------------
    // KEYBOARD NAV
    // -------------------------
    document.addEventListener("keydown", (e) => {
      const key = e.key;

      // Don’t steal keys while typing in search
      if (document.activeElement === elSearch && key !== "Escape") return;

      if (key === "ArrowDown") {
        selectedSongIndex = clamp(selectedSongIndex + 1, 0, Math.max(0, filtered.length - 1));
        selectedDiffIndex = 0;
        syncDetails(true);
        e.preventDefault();
      } else if (key === "ArrowUp") {
        selectedSongIndex = clamp(selectedSongIndex - 1, 0, Math.max(0, filtered.length - 1));
        selectedDiffIndex = 0;
        syncDetails(true);
        e.preventDefault();
      } else if (key === "ArrowRight") {
        selectedDiffIndex = clamp(selectedDiffIndex + 1, 0, Math.max(0, diffsForSelected.length - 1));
        syncDetails(false);
        e.preventDefault();
      } else if (key === "ArrowLeft") {
        selectedDiffIndex = clamp(selectedDiffIndex - 1, 0, Math.max(0, diffsForSelected.length - 1));
        syncDetails(false);
        e.preventDefault();
      } else if (key === "Enter") {
        startGameFromMenu();
        e.preventDefault();
      } else if (key === "Escape") {
        // Example: focus search or “back”
        elSearch.focus();
        e.preventDefault();
      }
    });

    // -------------------------
    // BUTTONS
    // -------------------------
    btnStart.addEventListener("click", startGameFromMenu);

    btnImport.addEventListener("click", () => {
      alert("Stub: Import R+ chart UI goes here (file picker). Keep logic in engine.");
    });

    btnAutogen.addEventListener("click", () => {
      alert("Stub: Autogen UI goes here (seed, density). Keep logic in engine.");
    });

    function startGameFromMenu() {
      const song = getSelectedSong();
      if (!song) return;

      const diffs = buildDiffs(song);
      const diff = diffs[selectedDiffIndex] || diffs[0] || "Normal";

      // This is where you call your rhythm engine:
      // engine.start(song.id, diff)
      console.log("START GAME:", { songId: song.id, diff });

      // Placeholder so you can see it works:
      btnStart.textContent = `Starting: ${song.title} (${diff})…`;
      setTimeout(() => btnStart.textContent = "Start (Enter)", 900);
    }

    // Boot
    syncDetails(true);

    // -------------------------
    // P5 BACKGROUND (animated, reactive to selection)
    // -------------------------
    new p5((p) => {
      let t = 0;

      p.setup = () => {
        const holder = document.getElementById("bg-canvas-holder");
        const cnv = p.createCanvas(holder.clientWidth, holder.clientHeight);
        cnv.parent(holder);
        p.noStroke();
      };

      p.windowResized = () => {
        const holder = document.getElementById("bg-canvas-holder");
        p.resizeCanvas(holder.clientWidth, holder.clientHeight);
      };

      p.draw = () => {
        t += 0.01;

        const st = window.__PB_MENU_STATE__ || { bpm: 120, diffIndex: 0 };
        const bpm = st.bpm || 120;
        const pulse = (p.sin((p.millis() / 1000) * (bpm / 60) * p.TWO_PI) + 1) * 0.5;

        // Background
        p.background(10, 12, 20);

        // Soft moving blobs (no fixed colors required; p5 uses default stroke/fill values here)
        const w = p.width, h = p.height;
        const layers = 18;

        for (let i = 0; i < layers; i++) {
          const k = i / layers;
          const x = w * (0.5 + 0.35 * p.sin(t * (0.7 + k) + i));
          const y = h * (0.5 + 0.25 * p.cos(t * (0.9 + k) - i * 0.7));
          const r = (120 + 280 * k) * (0.8 + 0.35 * pulse);

          p.fill(255, 255, 255, 10 + 25 * (1 - k));
          p.circle(x, y, r);
        }

        // “Highlight” indicator tied to difficulty index (just a vibe)
        const bandY = h * (0.15 + 0.12 * (st.diffIndex || 0));
        p.fill(255, 255, 255, 18);
        p.rect(0, bandY, w, h * 0.06);
      };
    }, document.getElementById("bg-canvas-holder"));
  </script>
</body>
</html>
